<meta charset="utf-8">
<div class='g-meta' style='display: none;'>油麻地佐敦一帶近日成為武漢肺炎重災區，1 月 1 日起，全港約四分一新增個案來自油尖旺區，當中逾半來自「指定區域」，即東至彌敦道，西至渡船街，北至甘肅街，南至佐敦道的範圍。</div><style>
	html, body {
	}
.g-body {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0;
  width: 100%;
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  color: #444;
  padding-top: 60px;
}
.g-kicker {
  text-align: center;
  margin-bottom: 20px;
}
.g-kicker .g-inner {
  display: inline;
  padding: 0 2px 5px 2px;
  border-bottom: 1px solid #d3d3d3;
}
.g-header .g-headline {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-weight: 700;
  margin: 0 auto 25px auto;
  font-size: 32px;
  line-height: 1.8;
  max-width: 720px;
}
.g-subhed {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-weight: 700;
  margin: 60px auto 25px auto;
  font-size: 24px;
  max-width: 600px;
}
.g-text {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  max-width: 600px;
  margin: 16px auto;
  font-size: 16px;
  line-height: 1.8;
  color: #444;
}
.g-bold {
  font-weight: 700;
}
.g-graphic {
  margin: 25px auto;
}
.g-graphic-text {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
}
.g-image {
  margin: 35px auto;
}
.g-image img {
  width: 100%;
  display: block;
  margin: 0 auto;
}
.g-image .g-credit {
  margin-top: 10px;
  font-size: 13px;
  text-align: center;
  color: #999;
  display: block;
}
.g-refer {
  border: 1px solid #ececec;
  border-radius: 5px;
  background: rgba(253, 232, 0, 0.05);
  padding: 10px 20px;
  max-width: 460px;
  margin: 35px auto;
}
.g-refer .g-text {
  font-size: 12px;
  margin: 0;
  line-height: 1.5;
}
.g-refer .g-text:first-child {
  margin-bottom: 5px;
  font-weight: 700;
}
.g-refer .g-bullet:before {
  content: "•";
  position: absolute;
  margin-left: -10px;
}
.g-break {
  margin: 50px auto;
  text-align: center;
}
.g-break em {
  margin-right: 40px;
  text-align: center;
}
.g-break em:last-child {
  margin-right: 0;
}
.cover-image-wrapper.mobile,
.author-wrapper {
  display: none !important;
}
.g-promo {
  max-width: 600px;
  margin: 25px auto;
  padding: 25px 0;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}
.g-promo a {
  color: #444;
  text-decoration: none;
  transition: opacity 0.2s;
}
.g-promo a:hover {
  opacity: 0.6;
}
.g-promo .g-promo-asset-cont,
.g-promo .g-promo-text-cont {
  display: inline-block;
  width: 100%;
  vertical-align: top;
}
@media screen and (min-width: 600px) {
  .g-promo .g-promo-asset-cont {
    width: calc(68% - 10px);
  }
}
@media screen and (min-width: 600px) {
  .g-promo .g-promo-text-cont {
    width: calc(32% - 10px);
  }
}
.g-promo .g-promo-text-cont {
  margin-right: 10px;
}
.g-promo .g-promo-tag {
  font-weight: 700;
  margin-bottom: 3px;
}
.g-promo .g-promo-hed {
  font-weight: 700;
  margin-bottom: 10px;
}
@media screen and (min-width: 460px) {
  .g-promo .g-promo-hed {
    max-width: none;
  }
}
.g-promo .g-promo-text {
  margin-bottom: 10px;
  font-size: 15px;
  padding: 0 16px;
}
@media screen and (min-width: 460px) {
  .g-promo .g-promo-text {
    padding: 0;
  }
}
.g-promo .g-youtube-cont {
  width: 100%;
  padding-bottom: 56%;
  position: relative;
}
.g-promo .g-youtube-cont iframe {
  position: absolute;
  top: 0;
  left: 0;
}
.g-promo .g-img-cont img {
  width: 100%;
}
.g-promo .g-mobile-hed {
  display: inline;
}
@media screen and (min-width: 460px) {
  .g-promo .g-mobile-hed {
    display: none;
  }
}
.g-promo .g-desktop-hed {
  display: none;
}
@media screen and (min-width: 460px) {
  .g-promo .g-desktop-hed {
    display: block;
  }
}
.g-note {
  font-size: 13px;
  text-align: center;
  color: #999;
}
.g-ymt-chart {
  max-width: 600px;
  margin: 0 auto;
}
.g-ymt-chart .g-building-name {
  font-size: 12px;
}
.g-ymt-chart path.domain {
  display: none;
}
.g-ymt-chart .g-chart-each {
  display: inline-block;
  width: 30%;
}
.g-ymt-chart svg {
  overflow: visible;
  padding-bottom: 10px;
  margin-bottom: 25px;
}
.g-ymt-chart text {
  font-size: 9px;
}
.two-col-cont {
  max-width: 600px;
  margin: 0 auto;
}
@media screen and (min-width: 600px) {
  .g-graphic.two-col {
    width: calc(50% - 3px);
    display: inline-block;
  }
}
.g-ymt-map {
  max-width: 600px;
  margin: 0 auto;
  display: block;
}
.g-ymt-map tspan:first-child {
  font-weight: 700;
}
.g-ymt-map .g-road-names {
  opacity: 0.6;
}
.g-ymt-map .g-road-names tspan:first-child {
  font-weight: normal;
}
.g-ymt-map .g-dont-bold tspan:first-child {
  font-weight: normal;
}
.g-ymt-map .g-circle-stroke,
.g-ymt-map .g-black-stroke {
  stroke: #000 !important;
}
.g-ymt-map .g-key {
  margin-bottom: 8px;
}
.g-ymt-map .g-key .g-key-each {
  display: inline-block;
  margin-right: 20px;
}
.g-ymt-map .g-key .g-key-each .g-circle,
.g-ymt-map .g-key .g-key-each .g-text {
  display: inline-block;
  vertical-align: middle;
}
.g-ymt-map .g-key .g-key-each .g-circle {
  width: 10px;
  height: 10px;
  border-radius: 100%;
  border: 2px solid #000;
}
.g-ymt-map .g-key .g-key-each .g-text {
  font-size: 12px;
  line-height: 0;
  margin: 0;
}
.tooltip {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-size: 11px;
  top: -1000px;
  position: fixed;
  padding: 4px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid lightgray;
  pointer-events: none;
}
.tooltip-hidden {
  opacity: 0;
  transition: all 0.3s;
  transition-delay: 0.1s;
}
@media (max-width: 590px) {
  div.tooltip {
    bottom: -1px;
    width: calc(100%);
    left: -1px !important;
    right: -1px !important;
    top: auto !important;
    width: auto !important;
  }
}
.g-graphic-hed {
  font-weight: 700;
  font-size: 14px;
  margin-top: 0;
  margin-bottom: 5px;
}
.g-nav {
  position: fixed;
  z-index: 99999999999;
  top: 0;
  left: 0;
  width: 100%;
  height: 40px;
  background: #000;
}

.g-nav img {
  height: 30px;
  display: block;
  margin: 0 auto;
  padding-top: 5px;
}

@media screen and (min-width: 600px) {
  .g-nav {
    height: 50px;
  }
  .g-nav img {
    height: 40px;
  }
}

.g-hed {
  text-align: center;
  font-weight: 700;
  font-size: 30px;
}

.g-byline {
  text-align: center;
  color: #999;
  font-size: 12px;
}
</style>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><div class="g-nav"><img src="../../img/snlogo.png"></div><div class="g-body"><div class="g-subhed g-hed">【武漢肺炎】油尖旺成疫區　「指定區域」個案佔逾半　地圖分析確診者足跡</div><div class="g-text g-byline">立場新聞 2021/01/19</div><div class="g-text">油麻地佐敦一帶近日成為武漢肺炎重災區，1 月 1 日起，全港約四分一新增個案來自油尖旺區，當中逾半來自「指定區域」，即東至彌敦道，西至渡船街，北至甘肅街，南至佐敦道的範圍。</div><div class="g-text">繼上星期劃出指定區域作強制檢測後，政府今日（19 日）公布再在範圍內劃出「核心區」，當中約 70 幢大廈均須強制檢測。</div><div class="g-graphic ymt-chart"><div class="g-text g-graphic-hed">1月至今確診本地個案地區分佈</div><div class="g-ymt-chart" data-id=""></div></div><div class="g-text">食物及衞生局上週（15 日）在油麻地佐敦區劃出指定區域，區內大廈凡有一宗確診個案，全幢大廈居民便須強制檢測。截至 1 月 18 日區內已有 37 幢大廈被納入其中， 13,400 名居民接受檢測。</div><div class="g-text">隨著疫情持續反覆，政府再宣佈更嚴格措施。在新「核心區」範圍內，即北至北海街、東到廟街兩旁、南至寧波街、西至新填地街兩旁的大廈，不論有否確診個案，均須強制檢測。</div><div class="g-text">《立場》分析衞生署數據，顯示有多棟鄰近「指定區域」的大廈亦有居民確診，但因不在範圍內而沒被列為強制檢測大廈。</div><div class="g-graphic ymt-map"><div class="g-text g-graphic-hed">1月至今本地確診者居住或到訪過的建築物</div><div class="g-ymt-map" data-id="dots-only"></div></div><div class="g-text">不少居於「指定區域」的確診者，足跡亦遍及「指定區域」以外。如個案編號 9552 及 9553 、均住在「指定區域」內的外判清潔工人，確診前曾於「指定區域」內外的多個公廁工作。</div><div class="two-col-cont"><div class="g-graphic ymt-map two-col"><div class="g-text g-graphic-hed">個案編號 9552 居住或到訪過的建築物</div><div class="g-ymt-map two-col" data-id="cleaning-staff-9552"></div></div><div class="g-graphic ymt-map two-col"><div class="g-text g-graphic-hed">個案編號 9553 居住或到訪過的建築物</div><div class="g-ymt-map two-col" data-id="cleaning-staff-9553"></div></div></div><div class="g-text">部分油尖旺「指定區域」的確診者，曾走訪全港多區各處。例如至少兩名將軍澳–藍田隧道的地盤工人住在「指定區域」內，確診前到過地盤上班。</div><div class="g-graphic ymt-map"><div class="g-text g-graphic-hed">「指定區域」確診人士居住或到訪過的區外建築物</div><div class="g-ymt-map" data-id="construction"></div></div></div><script src="d3_.js"></script><script src="topojson.min.js"></script><script src="cases-processed.js?awrsht"></script><script src="cases.js?aergh"></script><script src="hk_districts.js"></script><script src="innerlines.js"></script><script src="district.js"></script><script src="roads.js"></script><script src="shape.js?awetrsyduf"></script><script src="shape_fix.js"></script>
<script>
window.stopit = d3.timer(function(){
	d3.selectAll(".article-content-wrap:not(:first-child)").remove();
	d3.selectAll(".likecoin-embed:nth-child(n+3)").remove();
	d3.selectAll(".related-articles:nth-child(n+4)").remove();
})


var containerWidthChanged = false;
var ow = innerWidth;

d3.select('body').selectAppend('div.tooltip')

function drawYmtMap() {

	d3.selectAll(".g-ymt-map").each(function(el, eli){

		var sel = d3.select(this).html("");

		var type = sel.attr("data-id");

		if (type == "dots-only") {
			var key = sel.append("div.g-key");

			for (var i = 0; i < 2; i++) {
				var k = key.append("div.g-key-each");
				k.append("div.g-circle")
					.style("border-color", i == 0 ? "rgba(255,7,0,1)" : "rgba(255,196,0,1)")
				k.append("div.g-text")
					.text(i == 0 ? "「指定區域」內" : "「指定區域」外")
			}

		}


		var width = sel.node().getBoundingClientRect().width;
		var height = width;

		var svg = sel.append("svg").attr("width", width).attr("height", height);

		var district_shape = topojson.feature(district, district.objects.HKDistrict18)

		// var projection = d3.geoIdentity().reflectY(true).fitSize([width/2, height], topojson.feature(shape, shape.objects.shape1))
		var projection, path;

		if (type == "construction") {
		 	projection = d3.geoIdentity().reflectY(true).fitSize([width*2, height*2], topojson.feature(hk_districts, hk_districts.objects.HKDistrict18))
		 	path = d3.geoPath().projection(projection);
		 	svg = svg.append("g").translate([-width/2.8,-height/2])

		 

		} else {
			projection = d3.geoIdentity().reflectY(true).fitSize([width*3, height*3], district_shape)
			path = d3.geoPath().projection(projection);

			if (type.indexOf("cleaning-staff") > -1) {
				svg = svg.append("g").translate([-width/0.97, -height/0.9])
			} else {
				svg = svg.append("g").translate([-width/0.97, -height/0.8])
			}
		}

		svg.append("g").appendMany("path", district_shape.features)
			.style("fill", "#fff")
			.attr("d", path)

		if (type != "construction") {
			svg.append("g").appendMany("path", topojson.feature(roads, roads.objects["hk-roads"]).features)
				.style("fill", "none")
				.style("stroke", "#e8e8e8")
				.attr("d", path)
		}

		svg.append("g").appendMany("path", topojson.feature(shape_fix, shape_fix.objects["shapes"]).features)
			.style("fill", "rgba(255,160,0,0.05)")
			// .style("stroke", (d,i) => i == 0 ? "rgba(255,160,0,1)" : "rgba(255,0,0,1)")
			.style("stroke", (d,i) => "#000")
			.style("stroke-dasharray", (d,i) => i == 0 ? "2 2" : "1 1")
			.style("stroke-width", (d,i) => i == 0 ? 1 : 2)
			.attr("d", path)

		// svg.append("g").appendMany("path", topojson.feature(shape, shape.objects["new-shape"]).features)
		// 	.style("fill", "rgba(255,160,0,0.05)")
		// 	// .style("stroke", (d,i) => i == 0 ? "rgba(255,160,0,1)" : "rgba(255,0,0,1)")
		// 	.style("stroke", (d,i) => "#000")
		// 	.style("stroke-dasharray", (d,i) => i == 0 ? "2 2" : "1 1")
		// 	.style("stroke-width", (d,i) => i == 0 ? 1 : 2)
		// 	.attr("d", path)


		var datasets = [cases];
		var datname = ["cases-existing"]

		datasets.forEach(function(dat,i){

			var cases_a = topojson.feature(dat, dat.objects[datname[i]]).features;

			cases_a.forEach(function(d){
				d.datef = new Date(d.properties.實驗室確診報告日期.split("/")[2], d.properties.實驗室確診報告日期.split("/")[1]-1, d.properties.實驗室確診報告日期.split("/")[0]);
				d.case_no = d.properties.Case_no_;
			})

			// cases_a = cases_a.filter(d => d.properties.個案分類 != "輸入個案" && d.datef > new Date(2021,0,14));
			cases_a = cases_a.filter(d => d.properties.個案分類 != "輸入個案");

			if (type == "dots-only") {
				// cases_a = cases_a.filter(d => d.properties.大廈名單.indexOf(" (非住宅)") == -1);
			}

			var cases_grouped = d3.nest().key(d => d.geometry.coordinates).entries(cases_a);
			cases_grouped.sort((a,b) => b.values.length - a.values.length)

			var highlight = [8028,8521,8595,8870,8881,9101,9108,9118,9145,9146,9146,9165,9221,9222,9230,9244,9247,9263,9271,9272,9273,9274,9274,9275,9297,9298,9299,9302,9303,9304,9305,9306,9321,9321,9322,9323,9323,9326,9327,9328,9329,9330,9331,9336,9346,9351,9352,9353,9366,9372,9373,9374,9374,9375,9376,9377,9382,9383,9390,9391,9397,9406,9407,9410,9412,9414,9417,9418,9429,9432,9441,9445,9446,9447,9448,9450,9458,9465,9471,9472,9473,9475,9475,9491,9500,9501,9505,9506,9507,9508,9517,9518,9524,9527,9531,9549,9549,9552,9552,9552,9553,9553,9553,9568,9585,9586,9604,9606,9614,9622,9624,9625,9630,9631,9632,9634,9636,9637,9641,9643,9644,9645,9646,9647,9657,9660,9661,9662];

			var buildings_list = ["永安九龍中心 (非住宅)","油麻地街市 (非住宅)","立德大樓","廟街160號","新填地街26號","吳松街60號","廟街189號 Fusion Kitchen (非住宅)","南京街1D號","新填地街20號","炮台街46號","廣東道577號","廟街120-124A號","新填地街24號","吳松街90號","廟街151號","廟街124號","新填地街22號","佐敦大廈","廣東道514號","彌敦道315號","百誠大廈 大家樂 (非住宅)","上海街168號","瑜德大廈","廟街210 號","新填地街30號","金勳大廈","上海街163 - 165號","新填地街23號","廣基大廈","金威廣場","順利樓 (非住宅)","新填地街45A 號","統一大廈B座","金寶大廈","懷高大廈","金山大樓地下 (非住宅)","常安大廈","新填地街58號地下 (非住宅)","渡船街18號","炮台街公廁 (非住宅)","油麻地街巿公廁 (非住宅)","廟街157號","上海街184號","油麻地統一大廈B座","上海街174號","工商大廈 (非住宅)","新填地街18號","油麻地寶倫大廈","炮台街24號 (非住宅)","韶興大廈","廣東道542-544號","新填地街25號","廟街153號","廟街163號","永安九龍中心 聯邦金閣酒家 (非住宅)","廣東道565號 (非住宅)","吳松街93-103號德利樓","統一大廈A座","吳松街104號","恒成大廈 (非住宅)","南京大廈地下 (非住宅)","上海街102號","瑞香園大廈","炮台街60號","嘉賓商業大廈 (非住宅)","新填地街66號 (非住宅)","偉晴軒","白雲大廈 (非住宅)","彌敦道337 - 339號金滿樓 (非住宅)","上海街116號 樂園粉麵魚蛋大王 (非住宅)","南京街 香港餐室 (非住宅)","百誠大廈 麥當勞 (非住宅)","高怡醫務中心 (非住宅)","統一大廈 (非住宅)","彌敦道363-373號恒成大廈 (非住宅)","白加士街66 號 太興 (非住宅)","彌敦道 363 號恒成大廈 (非住宅)","白加士街 囍記車仔麵 (非住宅)","彌敦道363號 恒成大廈 (非住宅)","康僑大廈 七福神和食亭 (非住宅)","新填地街78-86 號金山樓 (非住宅)","廣發商業大廈 (非住宅)","新寶廣場(非住宅)","偉利閣","西貢街 廟街冰室 (非住宅)","渡船街6號","佐敦道41號 風彩餐廳 (非住宅)","德利樓","統一大廈 金發餐廳 (非住宅)","廟街109號","健峰保險大廈 金滿樓 (非住宅)","偉成大廈","金山大樓"]

			var inside = [];
			cases_grouped.forEach(function(d){
				d.case_nos = d.values.map(a => a.properties.Case_no_);
				var filteredArray = highlight.filter(value => d.case_nos.includes(value));

				if (filteredArray.length > 0) {

					filteredArray.forEach(function(a){
						if (inside.indexOf(a) == -1) {
							inside.push(a)
						}
					})

					d.is_small = true;
				}


				d.buildings_list = d.values.map(a => a.properties.大廈名單);
				var filteredArray = buildings_list.filter(value => d.buildings_list.includes(value));

				if (filteredArray.length > 0) {

					filteredArray.forEach(function(a){
						if (inside.indexOf(a) == -1) {
							inside.push(a)
						}
					})

					d.is_small_building = true;
				}
			})

			if (type != "dots-only") {

				var cases_filtered = cases_a.filter(d => inside.indexOf(d.properties.Case_no_) > -1);

				if (type == "cleaning-staff-9552") {
					cases_filtered = cases_a.filter(d => d.properties.Case_no_ == 9552);
				} else if (type == "cleaning-staff-9553") {
					cases_filtered = cases_a.filter(d => d.properties.Case_no_ == 9553);
				}

				cases_filtered.forEach(function(d){

					var match = cases_filtered.filter(a => a.case_no == d.case_no);
					var buildings = match.map(d => d.properties.大廈名單)

					if (match.length > 1) {

						var src = buildings.filter(d => d.indexOf(" (非住宅)") == -1)[0];

						if (!src) {
							if (buildings.indexOf("永安九龍中心 (非住宅)") > -1) {
								src = "永安九龍中心 (非住宅)"
							} else if (buildings.indexOf("油麻地街市 (非住宅)") > -1) {
								src = "油麻地街市 (非住宅)"
							} else {
								console.log(buildings)
							}
						}
							
						var srcd = match.filter(d => d.properties.大廈名單 == src)[0];

						match.forEach(function(m){
							var s = svg.append("path")
								.attr("data-class", ".g-" + d.case_no)
								.attr("d", function(){
									var switchsrc = ["天瑞邨瑞意樓", "翠屏北邨翠樟樓", "嘉福中心"];
									if (switchsrc.indexOf(d.properties.大廈名單) > -1 || switchsrc.indexOf(srcd.properties.大廈名單) > -1) {
										return "M" + path.centroid(srcd) + " L" + path.centroid(d)
									} else {
										return "M" + path.centroid(d) + " L" + path.centroid(srcd)
									}
									
								})
							
							var color = d3.interpolateRainbow;
							var color = d3.interpolateRgb("rgba(255,160,0,0.1)", "rgba(255,7,0,0.5)");


							svg.appendMany("path", quads(samples(s.node(), 8)))
								.attr("class", function(){
									// if (type == "construction" && (d.case_no == 9372 || d.case_no == 9377)) {
									// 	return "g-black-stroke g-" + d.case_no + " g-" + srcd.properties.Case_no_
									// } else {
										return "g-" + d.case_no + " g-" + srcd.properties.Case_no_
									// }
									
								})
							    .style("fill", function(d) { return color(d.t); })
							    .style("stroke", function(d) { return color(d.t); })
							    .attr("d", function(d) { 
							    	if (lineJoin(d[0], d[1], d[2], d[3], 0.5).indexOf("NaN") > -1) {
							    		return "";
							    	} else {
							    		return lineJoin(d[0], d[1], d[2], d[3], 0.5);
							    	}
							   	});

								s.call(d3.attachTooltip)
								.on("mouseover", function(){

									d.case_nos.forEach(function(c){
										d3.selectAll(".g-circle-" + c).raise()
										d3.selectAll(".g-" + c).raise()
										d3.selectAll(".g-circle-" + c).classed("g-circle-stroke", true)
										d3.selectAll(".g-" + c).classed("g-black-stroke", true)
									})
									d3.select('.tooltip').html("<b>個案編號 " + d.case_no + "</b><br>" + buildings.join("<br>") );
								})
								.on("mouseout", function(){
									d.case_nos.forEach(function(c){
										d3.selectAll(".g-circle-" + c).classed("g-circle-stroke", false)
										d3.selectAll(".g-" + c).classed("g-black-stroke", false)
									})
								})


						})
					}
					
				})
			}

			var cases_use;

			cases_use = cases_grouped
			
			if (type == "construction") {
				cases_use = cases_grouped.filter(d => d.is_small);
			} else if (type == "cleaning-staff-9552") {
				cases_use = cases_grouped.filter(d => d.case_nos.indexOf(9552) > -1);
			} else if (type == "cleaning-staff-9553") {
				cases_use = cases_grouped.filter(d => d.case_nos.indexOf(9553) > -1);
			} 

			cases_use.sort((a,b) => b.values.length - a.values.length)
			var circs = svg.append("g").appendMany("circle", cases_use)
				.attr("class", function(d){
					var case_nos = d.values.map(a => a.properties.Case_no_)
					case_nos = case_nos.join(" g-circle-")

					return "g-circle g-circle-" + case_nos;
				})
				.attr("r", d => type == "construction" ? 2 : d.values.length)
				.style("fill", function(d){
					if (type == "dots-only") {
						return "rgba(255,255,255,0.5)"
					} else {
						return "rgba(255,255,255,0)"
					}
				})
				.style("stroke", function(d){
					if (type == "dots-only") {
						return !d.is_small_building ? "rgb(255,196,0)" : "rgb(255,7,0)"
					} else if (type == "cleaning-staff-9552") {
						return d.case_nos.indexOf(9552) > -1 ? "rgb(0,0,0)" : "rgba(0,155,255, 0)"
					} else if (type == "cleaning-staff-9553") {
						return d.case_nos.indexOf(9553) > -1 ? "rgb(0,0,0)" : "rgba(0,155,255, 0)"
					} else {
						return !d.is_small_building ? "rgba(255,196,0,0.4)" : "rgba(255,7,0, 0.2)"
					}
					
				})
				.style("stroke-width", datname[i] != "cases-existing" ? 1 : 1.5)
				.translate(d => path.centroid(d.values[0]))
		
			if (type == "construction") {
				svg.selectAll(".g-circle-8955").classed("g-circle-stroke", true)
				// svg.selectAll(".g-9337").classed("g-black-stroke", true)
				// svg.selectAll(".g-9327").classed("g-black-stroke", true)
				var add = [cases_use.filter(d => d.buildings_list.indexOf("將軍澳–藍田隧道地盤 (非住宅)") > -1)[0]]
				svg.append("g").appendMany("text.g-dont-bold", add)
					.style("font-size", "11px")
					.style("text-anchor", "end")
					.translate(function(d){
						var pos = path.centroid(d.values[0])
						return [pos[0]+8, pos[1]+16]
					})
					.tspans(["將軍澳–藍田","隧道地盤"],13)
			}

			if (type.indexOf("cleaning-staff") > -1) {

				var adds = ["上海街/窩打老道公廁 (非住宅)", "加士居道公廁 (非住宅)", "連翔道公廁 (非住宅)", "佐敦道公廁 (非住宅)", "街巿街公廁 (非住宅)"];
				var offset = [[0,0],[0,0],[0,-8],[-35,12], [-10,-11]];
				adds.forEach(function(a,ai){
					var add = [cases_use.filter(d => d.buildings_list.indexOf(a) > -1)[0]]
					svg.append("g").appendMany("text.g-dont-bold", add)
						.style("font-size", "11px")
						.style("text-anchor", "start")
						.translate(function(d){
							var pos = path.centroid(d.values[0])
							return [pos[0]+6+offset[ai][0], pos[1]+4+offset[ai][1]]
						})
						.tspans([a.replace(" (非住宅)", "")],13)
				})
			}

			// if (type == "dots-only" || type == "construction") {

				circs.call(d3.attachTooltip)
					.on('mouseover', function(d){
						d.case_nos.forEach(function(c){
							if (type == "construction") {
								d3.selectAll(".g-circle-" + c).raise()
								d3.selectAll(".g-" + c).raise()	
							}
							
							d3.selectAll(".g-circle-" + c).classed("g-circle-stroke", true)
							d3.selectAll(".g-" + c).classed("g-black-stroke", true)
						})

						var str = "<b>" + d.values[0].properties.大廈名單 + "</b><br>" + d.values.length + " 確診"

						if (type == "construction") {
							str += "<br>" + d.values.filter(d => highlight.indexOf(d.properties.Case_no_) > -1).length + " 曾到「指定區域」"
						}
					    d3.select('.tooltip').html(str) 
					})
					.on("mouseout", function(d){
						d.case_nos.forEach(function(c){
							d3.selectAll(".g-" + c).classed("g-black-stroke", false)
							d3.selectAll(".g-circle-" + c).classed("g-circle-stroke", false)
						})
					})
			// }



		})	
	
		if (type != "construction") {
			svg.append("g").appendMany("text.g-road-names", topojson.feature(shape, shape.objects.shape2).features)
				.attr("text-anchor", "middle")
				.style("transform-origin", "top left")
				.style("pointer-events", "none")
				.style("transform", function(d,i){
					var pos = path.centroid(d);
					var x = pos[0];
					var y = pos[1];
					if (d.properties.name == "甘肅街") {
						return "translate(" + x + "px," + (y-3) + "px) rotate(15deg)"
					} else if (d.properties.name == "彌敦道") {
						return "translate(" + (x+3) + "px," + y + "px) rotate(85deg)"
					} else if (d.properties.name == "佐敦道") {
						return "translate(" + x + "px," + (y+10) + "px) rotate(15deg)"
					} else if (d.properties.name == "渡船街") {
						return "translate(" + (x-2) + "px," + y + "px) rotate(-74deg)"
					} else {
						return "translate(" + (x) + "px," + y + "px) rotate(0)"
					}
				})
				.style("font-size", "9px")
				.tspans((d,i) => d.properties.name.split(","), 11)
		}

		if (type == "dots-only") {
			var area_labels = {"objects":{"area_labels":{"geometries":[{"coordinates":[80,140],"properties":{"name":"「核心區」"},"type":"Point"},{"coordinates":[248,50],"properties":{"name":"「指定區域」"},"type":"Point"}],"type":"GeometryCollection"}},"transform":{"scale":[2.0876863350495696,1.9539215355478226],"translate":[12709004.349362643,2548208.681499959]},"type":"Topology"}
			var al = svg.append("g").appendMany("g", topojson.feature(area_labels, area_labels.objects.area_labels).features)
				.translate((d,i) => path.centroid(d))

			al.append("path")
				.style("stroke", "#000")
				.attr("d", (d,i) => i == 0 ? "" : "M0,0 L12,0")

			al.append("text")
				.style("font-size", "11px")
				.style("font-weight", 700)
				.translate((d,i) => i == 0 ? [38,5] : [10,5])
				.text((d,i) => d.properties.name)

		}

	})
	

}


function drawYmtChart() {

	var sel = d3.select(".g-ymt-chart").html("");

	var width = sel.node().getBoundingClientRect().width;

	cases_processed = cases_processed.filter(d => d.個案分類 != "輸入個案");

	var case_no_grouped = d3.nest().key(d => d.個案編號).entries(cases_processed)

	console.log(case_no_grouped)

	var grouped = d3.nest().key(d => d.values[0].實驗室確診報告日期).entries(case_no_grouped);
	var max = d3.max(grouped, d => d.values.length);

	var box_h = 10;
	var height = box_h*grouped.length + 3*grouped.length;
	var svg = sel.append("svg").attr("width", width).attr("height", height);

	var left_space = 32;
	var box_w = (width-left_space)/max - 1;

	grouped.forEach(function(group,gi){

		group.values.forEach(function(d){
			var is_small_all = d.values.map(d => d.is_small)
			d.sort = d.values[0].is_small == true ? 2 : d.values[0].地區 == "油尖旺" ? 1 : 0;
		})

		group.values.sort((a,b) => b.sort - a.sort);
		
		var xpos = gi*box_h+gi*3;
		svg.append("text")
			.translate([0,xpos+box_h-1])
			.style("font-size", "10px")
			.text(group.key.split("/")[1] + "." + group.key.split("/")[0])

		svg.append("g").translate([left_space,xpos]).appendMany("rect", group.values)
			.attr("width", box_w)
			.attr("height", box_h)
			.style("fill", d => d.values[0].is_small == true ? "rgb(255,7,0)" : d.values[0].地區 == "油尖旺" ? "rgb(255,196,0)" : "#ddd")
			.translate((d,i) => [box_w*i + i*1,0])
	})


	var last = grouped[grouped.length - 1].values;

	var second_no = 25;
	var third_no = 42;

	var x2 = ((box_w*second_no) + (second_no*1)) - 1;
	var x3 = ((box_w*(third_no)) + ((third_no)*1)) - 1;
	last.forEach(function(d,i){
		if (i == 0 || i == second_no) {
			var g = svg.append("g").translate([left_space,height-2]);

			if (i == 0) {
				g.append("path").style("stroke", "#999").style("fill", "none").attr("d", "M0,0 " + " L0,4 L" + (x2) + ",4 L" + x2 + ",0")	

				g.append("text")
					.attr("text-anchor", "middle")
					.text("「指定區域」")
					.attr("dx", (x2/2))
					.attr("dy", 15)

			} else {
				g.append("path").style("stroke", "#999").style("fill", "none").attr("d", "M0,18 " + " L0,22 L" + (x3) + ",22 L" + x3 + ",18")	

				g.append("text")
					.attr("text-anchor", "middle")
					.text("油尖旺")
					.attr("dx", x3/2)
					.attr("dy", 34)
			}
			

			
		}
		
	})


}



drawYmtMap();
drawYmtChart();
window.addEventListener("resize", function(){
	if (innerWidth != ow) {
	    containerWidthChanged = true;
	    ow = innerWidth;
	    drawYmtMap();
	    drawYmtChart();
	  }
});



// Compute quads of adjacent points [p0, p1, p2, p3].
function quads(points) {
  return d3.range(points.length - 1).map(function(i) {
    var a = [points[i - 1], points[i], points[i + 1], points[i + 2]];
    a.t = (points[i].t + points[i + 1].t) / 2;
    return a;
  });
}

// Sample the SVG path uniformly with the specified precision.
function samples(path, precision) {
  var n = path.getTotalLength(), t = [0], i = 0, dt = precision;
  while ((i += dt) < n) t.push(i);
  t.push(n);
  return t.map(function(t) {
    var p = path.getPointAtLength(t), a = [p.x, p.y];
    a.t = t / n;
    return a;
  });
}

// Compute stroke outline for segment p12.
function lineJoin(p0, p1, p2, p3, width) {
  var u12 = perp(p1, p2),
      r = width / 2,
      a = [p1[0] + u12[0] * r, p1[1] + u12[1] * r],
      b = [p2[0] + u12[0] * r, p2[1] + u12[1] * r],
      c = [p2[0] - u12[0] * r, p2[1] - u12[1] * r],
      d = [p1[0] - u12[0] * r, p1[1] - u12[1] * r];

  if (p0) { // clip ad and dc using average of u01 and u12
    var u01 = perp(p0, p1), e = [p1[0] + u01[0] + u12[0], p1[1] + u01[1] + u12[1]];
    a = lineIntersect(p1, e, a, b);
    d = lineIntersect(p1, e, d, c);
  }

  if (p3) { // clip ab and dc using average of u12 and u23
    var u23 = perp(p2, p3), e = [p2[0] + u23[0] + u12[0], p2[1] + u23[1] + u12[1]];
    b = lineIntersect(p2, e, a, b);
    c = lineIntersect(p2, e, d, c);
  }

  return "M" + a + "L" + b + " " + c + " " + d + "Z";
}

// Compute intersection of two infinite lines ab and cd.
function lineIntersect(a, b, c, d) {
  var x1 = c[0], x3 = a[0], x21 = d[0] - x1, x43 = b[0] - x3,
      y1 = c[1], y3 = a[1], y21 = d[1] - y1, y43 = b[1] - y3,
      ua = (x43 * (y1 - y3) - y43 * (x1 - x3)) / (y43 * x21 - x43 * y21);
  return [x1 + ua * x21, y1 + ua * y21];
}

// Compute unit vector perpendicular to p01.
function perp(p0, p1) {
  var u01x = p0[1] - p1[1], u01y = p1[0] - p0[0],
      u01d = Math.sqrt(u01x * u01x + u01y * u01y);
  return [u01x / u01d, u01y / u01d];
}

</script>