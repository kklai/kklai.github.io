<meta charset="utf-8">
<div class='g-meta' style='display: none;'>2019年 11 月 4 日凌晨，科大學生周梓樂在將軍澳尚德邨停車場墮樓，傷重不治，死因庭將於本月 16 日召開聆訊，為期五周。《立場》以 3D 模型重組當晚現場，在死因庭研訊開始之前，為讀者梳理事件值得關注的疑點。</div><style>
.g-body {
  margin: 0 auto;
  padding: 0;
  width: 100%;
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  color: #444;
}
.g-kicker {
  text-align: center;
  margin-bottom: 20px;
}
.g-kicker .g-inner {
  display: inline;
  padding: 0 2px 5px 2px;
  border-bottom: 1px solid #d3d3d3;
}
.g-header .g-headline {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-weight: 700;
  margin: 0 auto 25px auto;
  font-size: 32px;
  line-height: 1.8;
  max-width: 720px;
}
.g-subhed {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-weight: 700;
  margin: 60px auto 25px auto;
  font-size: 24px;
  max-width: 600px;
}
.g-text {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  max-width: 600px;
  margin: 16px auto;
  font-size: 16px;
  line-height: 1.8;
  color: #444;
}
.g-bold {
  font-weight: 700;
}
.g-graphic {
  margin: 25px auto;
}
.g-graphic-text {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
}
.g-image {
  margin: 35px auto;
}
.g-image img {
  width: 100%;
  display: block;
  margin: 0 auto;
}
.g-image .g-credit {
  margin-top: 10px;
  font-size: 13px;
  text-align: center;
  color: #999;
  display: block;
}
.g-refer {
  border: 1px solid #ececec;
  border-radius: 5px;
  background: rgba(253, 232, 0, 0.05);
  padding: 10px 20px;
  max-width: 460px;
  margin: 35px auto;
}
.g-refer .g-text {
  font-size: 12px;
  margin: 0;
  line-height: 1.5;
}
.g-refer .g-text:first-child {
  margin-bottom: 5px;
  font-weight: 700;
}
.g-refer .g-bullet:before {
  content: "•";
  position: absolute;
  margin-left: -10px;
}
.g-break {
  margin: 50px auto;
  text-align: center;
}
.g-break em {
  margin-right: 40px;
  text-align: center;
}
.g-break em:last-child {
  margin-right: 0;
}
.cover-image-wrapper.mobile,
.author-wrapper {
  display: none !important;
}
.g-promo {
  max-width: 600px;
  margin: 25px auto;
  padding: 25px 0;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}
.g-promo a {
  color: #444;
  text-decoration: none;
  transition: opacity 0.2s;
}
.g-promo a:hover {
  opacity: 0.6;
}
.g-promo .g-promo-asset-cont,
.g-promo .g-promo-text-cont {
  display: inline-block;
  width: 100%;
  vertical-align: top;
}
@media screen and (min-width: 600px) {
  .g-promo .g-promo-asset-cont {
    width: calc(68% - 10px);
  }
}
@media screen and (min-width: 600px) {
  .g-promo .g-promo-text-cont {
    width: calc(32% - 10px);
  }
}
.g-promo .g-promo-text-cont {
  margin-right: 10px;
}
.g-promo .g-promo-tag {
  font-weight: 700;
  margin-bottom: 3px;
}
.g-promo .g-promo-hed {
  font-weight: 700;
  margin-bottom: 10px;
}
@media screen and (min-width: 460px) {
  .g-promo .g-promo-hed {
    max-width: none;
  }
}
.g-promo .g-promo-text {
  margin-bottom: 10px;
  font-size: 15px;
  padding: 0 16px;
}
@media screen and (min-width: 460px) {
  .g-promo .g-promo-text {
    padding: 0;
  }
}
.g-promo .g-youtube-cont {
  width: 100%;
  padding-bottom: 56%;
  position: relative;
}
.g-promo .g-youtube-cont iframe {
  position: absolute;
  top: 0;
  left: 0;
}
.g-promo .g-img-cont img {
  width: 100%;
}
.g-promo .g-mobile-hed {
  display: inline;
}
@media screen and (min-width: 460px) {
  .g-promo .g-mobile-hed {
    display: none;
  }
}
.g-promo .g-desktop-hed {
  display: none;
}
@media screen and (min-width: 460px) {
  .g-promo .g-desktop-hed {
    display: block;
  }
}
.g-note {
  font-size: 13px;
  text-align: center;
  color: #999;
}
.social-wrap.hidden-print,
.mobile-ad.article-top-ad.center {
  display: none !important;
}
.article-blog-page .related-articles {
  width: 100%;
}
.header-wrap.container {
  display: none !important;
}
.articles {
  padding: 0 !important;
}
.col-xs-12 {
  padding: 0;
}
.container.blog-container {
  width: 100%;
}
.page-content {
  padding: 0 !important;
}
.today-articles-outer-wrapper {
  display: none !important;
}
.article-page .article-content-wrap {
  padding-top: 0 !important;
  margin-top: -5px;
}
.article-page .article-content-wrap .date,
.article-page .article-content-wrap .article-name {
  display: none !important;
}
@media screen and (max-width: 767px) {
  .article-page .article-content-wrap .date,
  .article-page .article-content-wrap .article-name {
    display: none !important;
  }
}
body,
html {
  margin: 0;
  background: #000;
}
.g-cover-img {
  position: fixed;
  top: 0 !important;
  z-index: 0;
  left: 0;
  background: linear-gradient(#000000, rgba(0, 0, 0, 0) 30%);
  width: 100%;
  height: 100vh;
  transition: 1s opacity;
}
.g-cover-img.g-hide {
  opacity: 0;
  pointer-events: none;
}
.g-cover-img img {
  width: 100%;
  max-width: 300px !important;
  margin-top: 60px;
  margin-left: auto;
  margin-right: auto;
  display: block;
}
@media screen and (min-width: 768px) {
  .g-cover-img img {
    margin-top: 60px;
    max-width: 420px !important;
    margin-left: 5%;
  }
}
.g-body {
  position: relative;
  background: #000;
}
.g-body-interactive .g-item-sticky {
  pointer-events: auto;
}
.g-body-interactive .g-buttons {
  display: block;
}
.g-body-interactive .g-item-text-cont {
  pointer-events: none;
  opacity: 0;
  display: none;
}
.g-item-sticky {
  position: fixed;
  top: 0;
  left: 0;
  pointer-events: none;
}
.g-item-sticky:focus {
  outline: none;
}
.g-item-sticky video {
  position: fixed;
  left: 0;
  top: 0;
  min-width: 100%;
  min-height: 100%;
  width: 100%;
}
.g-clock {
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  position: fixed;
  z-index: 10;
  top: 60px;
  font-size: 20px;
  color: #bf0000;
  width: 100%;
  opacity: 0;
  transition: opacity 0.5s;
  line-height: 1;
  background: #000;
  padding: 0;
  top: 39px;
}
@media screen and (min-width: 1200px) {
  .g-clock {
    top: 56px;
  }
}
.g-clock .g-clock-right-col {
  text-align: left;
  display: inline-block;
  vertical-align: top;
  text-align: right;
  position: absolute;
  right: 5px;
  top: 14px;
  background: #000;
  padding-left: 13px;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-right-col {
    text-align: left;
    margin-top: 1px;
    margin-left: 20px;
    position: relative;
    top: 0px;
  }
}
.g-clock .g-clock-time {
  font-size: 15px;
  line-height: 1.1;
  color: #fff;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-time {
    font-size: 19px;
  }
}
.g-clock .g-clock-time b {
  font-weight: 700;
  display: inline-block;
  margin: 0 2px 0 1px;
  vertical-align: top;
  font-size: 14px;
  animation: blinker2 1s infinite step-end;
  animation-direction: reverse;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-time b {
    margin-top: 1px;
  }
}
@keyframes blinker2 {
  0% {
    opacity: 1;
  }
  70% {
    opacity: 0;
  }
}
.g-clock .g-clock-date {
  font-size: 8px;
  color: #bdbdbd;
  font-weight: 300;
  letter-spacing: 0.5px;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-date {
    top: 28px;
    right: 11px;
    font-size: 9px;
    margin-left: 0.8px;
  }
}
.g-clock .g-clock-countdown {
  text-align: left;
  font-weight: 700;
  margin-left: 6px;
  letter-spacing: -1.8px;
  font-size: 22.3px;
  display: inline-block;
  font-weight: 500;
}
.g-clock .g-clock-countdown i {
  font-style: normal;
  font-weight: 700;
}
.g-clock .g-clock-countdown b {
  margin: 0px 1px 0 2px;
  letter-spacing: 0;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-countdown {
    font-size: 30px;
  }
}
.g-clock .g-clock-countdown.g-flashing {
  animation: blinker 1s linear infinite;
}
@keyframes blinker {
  20% {
    opacity: 0.2;
  }
}
.g-clock .g-clock-countdown-outer {
  width: 100%;
}
@media screen and (min-width: 768px) {
  .g-clock .g-clock-countdown-outer {
    margin-left: calc(5% + 20px);
  }
}
.g-clock.g-active {
  opacity: 1;
  margin-top: 0;
  margin-left: 0;
  z-index: 16;
  height: 30px;
  padding-top: 15px;
}
@media screen and (min-width: 1200px) {
  .g-clock.g-active {
    padding-top: 10px;
    height: 40px;
  }
}
.g-clock .g-num {
  font-size: 22px;
  margin: 3px 3px -2px 3px;
}
@media screen and (min-width: 460px) {
  .g-clock .g-num {
    font-size: 32px;
  }
}
.g-item-text-cont {
  position: relative;
  width: 100%;
  display: none;
}
.g-item-text-cont.g-active {
  display: block;
}
.g-item-text-cont .g-item-text {
  padding-top: 20vh;
  padding-bottom: 20vh;
}
.g-item-text-cont .g-item-text.g-item-text-0 .g-share-button-cont {
  margin-top: 10px;
  width: 100%;
  display: block;
}
.g-item-text-cont .g-item-text.g-item-text-0 .g-share-button-cont .fb-like {
  display: block;
  width: 100%;
}
.g-item-text-cont .g-item-text.g-item-text-0 .g-share-button-cont .fb-like span {
  width: 100% !important;
}
.g-item-text-cont .g-item-text.g-item-text-0 .g-share-button-cont iframe {
  width: 100% !important;
}
.g-item-text-cont .g-item-text.g-item-text-4 .g-item-text-inner .g-vid video,
.g-item-text-cont .g-item-text.g-item-text-7 .g-item-text-inner .g-vid video,
.g-item-text-cont .g-item-text.g-item-text-8 .g-item-text-inner .g-vid video,
.g-item-text-cont .g-item-text.g-item-text-11 .g-item-text-inner .g-vid video {
  top: 0;
}
.g-item-text-cont .g-item-text.g-item-text-10 .g-item-text-inner .g-item-text-inner-2 .g-text .g-highlight-inner {
  background: #ffcc00;
  color: #333;
  display: inline;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 1px;
}
.g-item-text-cont .g-item-text.g-item-text-15 .g-highlight:last-child .g-highlight-inner {
  font-size: 13px;
  line-height: 1.4;
  margin-top: 10px;
  color: #999;
}
.g-item-text-cont .g-item-text.g-item-text-last {
  padding-bottom: 0;
}
.g-item-text-cont .g-item-text.g-item-text-empty .g-item-text-inner {
  background: none;
}
.g-item-text-cont .g-item-text .g-item-text-inner-sticky {
  height: 200vh;
  position: relative;
  overflow: visible;
}
@media screen and (min-width: 1050px) {
  .g-item-text-cont .g-item-text .g-item-text-inner-sticky {
    height: 160vh;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner {
  max-width: 521px;
  margin: 0 auto;
  position: sticky;
  top: auto;
  overflow: hidden;
}
.g-item-text-cont .g-item-text .g-item-text-inner i {
  font-style: normal;
  display: block;
}
@media screen and (min-width: 720px) {
  .g-item-text-cont .g-item-text .g-item-text-inner {
    margin-left: 5%;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-item-text-inner-2 {
  background: rgba(0, 0, 0, 0.9);
  padding: 15px 20px;
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-hed {
  font-size: 23px;
  font-weight: 700;
  margin-bottom: 10px;
  color: #fafafa;
}
@media screen and (min-width: 460px) {
  .g-item-text-cont .g-item-text .g-item-text-inner .g-hed {
    font-size: 32px;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-text {
  margin: 0;
  color: #fafafa;
  font-size: 15.2px;
  line-height: 1.6;
}
@media screen and (min-width: 460px) {
  .g-item-text-cont .g-item-text .g-item-text-inner .g-text {
    font-size: 16px;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-text strong {
  background: #ffcc00;
  padding: 1px 2px;
  color: #333;
  border-radius: 1px;
  margin: 0 3px;
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-caption {
  color: #8c8c8c;
  font-size: 11px;
  margin: 5px 0 0 0;
}
.g-item-text-cont .g-item-text .g-item-text-inner video,
.g-item-text-cont .g-item-text .g-item-text-inner img {
  width: 100%;
  margin-top: 10px;
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-vid {
  margin-top: 10px;
  padding-bottom: 40%;
  position: relative;
  overflow: hidden;
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-vid .g-vid-time {
  position: absolute;
  bottom: 10px;
  left: 10px;
  padding: 3px;
  color: #fff;
  background: #313132;
  font-size: 14px;
  opacity: 1;
}
@media screen and (min-width: 768px) {
  .g-item-text-cont .g-item-text .g-item-text-inner .g-vid {
    padding-bottom: 0;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-vid video {
  margin-top: 0;
  position: absolute;
  top: -20%;
  left: 0;
}
@media screen and (min-width: 768px) {
  .g-item-text-cont .g-item-text .g-item-text-inner .g-vid video {
    position: relative;
  }
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-fb-cont {
  width: 100%;
  padding-bottom: 56%;
  position: relative;
}
.g-item-text-cont .g-item-text .g-item-text-inner .g-fb-cont iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
.g-buttons {
  position: absolute;
  z-index: 3;
  top: 10px;
  right: 10px;
  display: none;
}
.g-buttons .g-border {
  width: 100%;
  border: 1px solid #999;
  margin: 20px 0 20px 0;
}
.g-buttons .g-button {
  width: 70px;
  height: 70px;
  background: #ddd;
  margin-bottom: 10px;
  border: 1px solid #999;
  border-radius: 5px;
  background-size: 70%;
  background-repeat: no-repeat;
  background-position: 40% 50%;
  opacity: 0.5;
}
.g-buttons .g-button.g-button-mouse {
  background-image: url("https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/mouse.png");
}
.g-buttons .g-button.g-button-pencil {
  background-image: url("https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/pencil.png");
}
.g-buttons .g-button.g-button-views {
  height: 40px;
  text-align: center;
  padding-top: 10px;
}
.g-buttons .g-button.g-active {
  opacity: 1;
}
.g-buttons .g-button:hover {
  cursor: pointer;
  opacity: 0.8;
}
#g-model-cont {
  width: 100vw;
  height: 100vh;
  background: #000;
  opacity: 0;
  transition: opacity 1s;
}
#g-model-cont.g-loaded {
  opacity: 1;
}
body:focus,
.g-body:focus,
.g-item-sticky:focus,
#g-model-cont:focus,
canvas:focus {
  outline: none;
}
#g-drawing-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  display: none;
}
#g-drawing-canvas.g-active {
  display: block;
}
.today-articles-outer-wrapper.hidden-print,
.floating-share-buttons-wrapper.shown {
  display: none !important;
}
.related-articles.clearfix {
  background: #fff;
  position: relative;
  width: 100%;
  margin: 0;
}
footer {
  position: relative;
}
.likecoin-embed.likecoin-like-rewards-button.likecoin-like-rewards-button--default {
  background: #fff;
}
.article-page .article-content-wrap {
  overflow: visible;
}
.article-page .article-ad {
  padding: 0 !important;
  width: 100% !important;
  overflow: hidden !important;
}
.article-photo.article-media {
  display: none !important;
}
.ArticleDetail_article__author--specialLayout__3Wnfe,
.ArticleDetail_toolbar--specialLayout__32ILm,
.ArticleDetail_article__title__YNzig {
  display: none;
}
.ArticleDetail_articleShareWidget__1M_8z {
  background: #000;
}
.ArticleDetailSpecialLayout_contentContainer__3i4U-,
.ArticleDetail_article--specialLayout__Z5ois,
.ArticleDetail_mobileTopAd__3XVFL {
  max-width: none;
}
.ArticleDetailSpecialLayout_articleDetail__container__9-z0R {
  margin-bottom: 0;
}
.ArticleDetailSpecialLayout_articleDetail__relatedArticlesContainer__1Rlzq {
  background: #000;
  position: relative;
  margin-top: 0;
}
.ArticleDetail_pageFlip__2JpX2 {
  display: none;
}
.ArticleDetail_bottomAd__1pMho {
  position: relative;
  background: #000;
  margin: 0;
}
.LikeCoinButton_likeCoinButton__11znt {
  background: #000;
  position: relative;
}
.RelatedArticleListItem_relatedArticle__title--bottom__sJZF9 {
  color: #fff;
  margin-top: 5px;
}
.g-nav {
  background: #000;
  color: #fff;
  font-size: 25px;
  text-align: center;
  padding: 5px 0 7px 0;
  font-family: droid sans, helvetica neue, Helvetica, Arial, sans-serif;
  font-weight: 700;
  z-index: 10;
  position: fixed;
  width: 100%;
  padding: 5px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}
@media screen and (min-width: 1200px) {
  .g-nav {
    padding: 10px 0;
  }
}
.g-nav img {
  max-width: 88px;
}
@media screen and (min-width: 1200px) {
  .g-nav img {
    max-width: 110px;
  }
}
.g-nav a {
  color: #fff;
}
.g-nav a:hover {
  color: #fff;
}
</style>
<div id="fb-root"></div><script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v8.0&appId=753627645460951&autoLogAppEvents=1" nonce="iiRVAXoF"></script><link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"><div class="g-nav"><a href="https://thestandnews.com"><img src="snlogo.png" alt="立場新聞"></a></div><div class="g-clock"><div class="g-clock-inner"><div class="g-clock-countdown-outer"><div class="g-clock-countdown">被發現墮樓前<b>2</b><i>小時</i></div><div class="g-clock-right-col"><div class="g-clock-time">23<b>:</b>06</div><div class="g-clock-date">2019.11.3</div></div></div></div></div><div class="g-body">  <div class="g-item-sticky">    <div id="g-model-cont"></div>  </div>  <div class="g-cover-img"><img src="chow-cover-small.png"></div>    <div class="g-item-text-cont">        <div class="g-item-text g-item-text-0  " data-time="" data-actualtime="" data-id="0">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">        <div class="g-hed">未解的真相　周梓樂之死 3D 模擬事發現場</div>                <div class="g-text">2019年 11 月 4 日凌晨，科大學生周梓樂在將軍澳尚德邨停車場墮樓，傷重不治，死因庭將於本月 16 日召開聆訊，為期五周。《立場》以 3D 模型重組當晚現場，在死因庭研訊開始之前，為讀者梳理事件值得關注的疑點。</div>                <div class="g-share-button-cont">          <div class="fb-like" data-href="https://www.thestandnews.com/politics/%E6%9C%AA%E8%A7%A3%E7%9A%84%E7%9C%9F%E7%9B%B8-%E5%91%A8%E6%A2%93%E6%A8%82%E4%B9%8B%E6%AD%BB-3d-%E6%A8%A1%E6%93%AC%E4%BA%8B%E7%99%BC%E7%8F%BE%E5%A0%B4/" data-width="100%" data-layout="button_count" data-action="like" data-size="small" data-share="true"></div>        </div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-1  " data-time="" data-actualtime="" data-id="1">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">2019 年 11 月 3 日夜晚，大批示威者在唐明街及唐俊街交界聚集，有防暴警員到場，雙方對峙。</div>                        <div class="g-vid"><video autoplay muted playsinline loop poster="vid1.jpg?awetrsyduf" data-src="vid1-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">《立場》現場片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-2  " data-time="被發現墮樓前 2 小時" data-actualtime="23:06" data-id="2">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">警方曾指周梓樂墮樓後才首次進入停車場，直至其後被揭發有警員在周墮樓前步出停車場，警方才承認曾於 23:06 - 23:20 進入停車場，但強調之後再無警員在內。<strong>疑點：周梓樂墮樓前，警方在何時進入停車場？</strong></div>                        <div class="g-vid"><video autoplay muted playsinline loop poster="vid2.jpg?awetrsyduf" data-src="vid2-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">眾新聞行車記錄儀片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-3  " data-time="被發現墮樓前 40 分鐘" data-actualtime="00:26" data-id="3">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">警方表示，周梓樂此時從富康花園天橋進入尚德邨停車場。警方指有影片為證，但從來未公開【註】</div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-4  " data-time="被發現墮樓前 38 分鐘" data-actualtime="00:28" data-id="4">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">閉路電視見疑似周梓樂身影在停車場 2.5 層近唐明街位置徘徊，警方聲稱期間未見他與人接觸。</div>                        <div class="g-vid"><video autoplay muted playsinline loop poster="cctv-compile.jpg?awetrsyduf" data-src="cctv-compile-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">領展公布閉路電視片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-5  " data-time="被發現墮樓前 9 分鐘" data-actualtime="00:57" data-id="5">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">警方於唐明街及唐俊街交界，以及廣明苑廣昌閣對出向停車場射催淚彈，有催淚彈射進二樓，位置距離周梓樂倒地處約 120 米，閉路電視及目擊者均未見停車場內有催淚煙。<strong>疑點：警方發射催淚彈，有影響停車場內環境嗎？</strong></div>                        <div class="g-vid"><div class="g-vid-time">01:01</div><video autoplay muted playsinline loop poster="vid-live-tg.jpg?awetrsyduf" data-src="vid-live-tg-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">《立場》現場片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-6  " data-time="被發現墮樓前 6 分鐘" data-actualtime="01:00" data-id="6">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">警方聲稱，周梓樂沿富康花園行人天橋離開停車場，一分鐘後原路折返停車場，惟未有閉路電視片段證實。周梓樂為何折返停車場？警方為何不公開影片？【註】</div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-7  " data-time="被發現墮樓前 4 分鐘" data-actualtime="01:02" data-id="7">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">閉路電視見疑似周梓樂身影在 2.5 樓走上 3 樓。在 01:02 後，閉路電視鏡頭轉動，加上有車輛阻擋，再沒有閉路電視拍攝到疑似周梓樂的畫面。</div>                        <div class="g-vid"><div class="g-vid-time">01:02</div><video autoplay muted playsinline loop poster="cctv-last-seen.jpg?awetrsyduf" data-src="cctv-last-seen-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">領展公布閉路電視片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-8  " data-time="被發現墮樓前 1 分鐘" data-actualtime="01:05" data-id="8">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">閉路電視見大批防暴警員從地下進入尚德邨停車場。不足一分鐘後，周梓樂被發現倒臥在 2 樓。</div>                        <div class="g-vid"><div class="g-vid-time">01:05</div><video autoplay muted playsinline loop poster="cctv-police.jpg?awetrsyduf" data-src="cctv-police-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">領展公布閉路電視片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-9  " data-time="墮樓一刻" data-actualtime="01:02-01:06" data-id="9">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">周梓樂墮樓，手腳沒明顯傷勢，傷勢集中在右邊，右邊盆骨髂骨翼骨折，學者分析：有機會墮樓前已失知覺。<strong>他墮樓前發生了什麼？</strong></div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-10  " data-time="墮樓一刻" data-actualtime="01:02-01:06" data-id="10">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text"><div class='g-highlight'><div class='g-highlight-inner'>周梓樂墮樓三大疑點：</div></div><div class='g-highlight'><div class='g-highlight-inner'> 1. 他為何翻越圍牆？</div></div><div class='g-highlight'><div class='g-highlight-inner'> 2. 是否知悉牆後高度？</div></div><div class='g-highlight'><div class='g-highlight-inner'> 3. 翻越前會否已失去意識？</div></div></div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-11  " data-time="被發現墮樓後" data-actualtime="01:06" data-id="11">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">有人發現周梓樂倒地，並帶消防員到 2 樓周梓樂倒地位置救治。</div>                        <div class="g-vid"><div class="g-vid-time">1:06</div><video autoplay muted playsinline loop poster="cctv-fireman.jpg?awetrsyduf" data-src="cctv-fireman-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">領展公布閉路電視片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-12  " data-time="被發現墮樓後 9 分鐘" data-actualtime="01:15" data-id="12">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">防暴警經過周梓樂墮樓位置，現場義務急救員向端傳媒表示，曾有警員持槍指令消防離開，消防員解釋後，一名警員走近查看，但並無干預。</div>                        <div class="g-vid"><div class="g-vid-time">1:15</div><video autoplay muted playsinline loop poster="cctv-after.jpg?awetrsyduf" data-src="cctv-after-600.mp4?2rw43et5df"></video></div>                        <div class="g-caption">領展公布閉路電視片段</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-13  " data-time="被發現墮樓後 14 分鐘" data-actualtime="01:20" data-id="13">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">救護車 A344 因受阻要繞道而行，最終救護員更要步行 400 米往停車場；另一架 A346 在 3 分鐘後到唐俊街與唐明街十字路口，因催淚彈及警車受阻。</div>                                  <div class="g-vid"><video autoplay muted playsinline loop poster="ambulance.jpg"></video></div>                <div class="g-caption">A346受阻（網上圖片）</div>        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-14  " data-time="被發現墮樓後 23 分鐘" data-actualtime="01:29" data-id="14">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text">救護員到達周梓樂位置，即從接報至到場用了 19 分鐘， 比 12 分鐘的服務承諾遲了 7  分鐘。周梓樂最終在 01:59 送抵伊利沙伯醫院。</div>                                        </div>      </div>      </div>    </div>        <div class="g-item-text g-item-text-15 g-item-text-last " data-time="" data-actualtime="" data-id="15">      <div class="g-item-text-inner-sticky">      <div class="g-item-text-inner">        <div class="g-item-text-inner-2">                        <div class="g-text"><div class='g-highlight'><div class='g-highlight-inner'>周梓樂最後於 11 月 8 日不治。其離世引起極大關注，不少市民事隔一年仍繼續悼念，惟其墮樓原因依然未明。是次死因庭將傳召超過 60 名證人及播放閉路電視片段，考究周梓樂死因。包括<strong>警方何時進入停車場</strong>、<strong>周梓樂的墮樓與警方行動有否關係</strong>、<strong>他墮樓時的情形</strong>、<strong>警方行動有否阻礙救援</strong>等疑點，亦期望可於死因庭解開。《立場》將每日跟進發展，以及透過每晚直播節目，與讀者分析死因庭資訊。</div></div><div class='g-highlight'><div class='g-highlight-inner'>【註】《立場》已向警方查詢，能否公開拍攝到周梓樂身影的閉路電視等，警方僅表示，東九龍總區重案組已經完成該宗事件的相關調查，並已將有關閉路電視片段及其他證據交與死因裁判官。</div></div></div>                                        </div>      </div>      </div>    </div>      </div></div><!-- The main three.js file --><script src="d3_.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/ScrollMagic/2.0.8/ScrollMagic.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
var prefix = ""
// "https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/"

d3.select(".g-item-text-cont").classed("g-active", true)
if (innerWidth < 460) {
  d3.select(".g-item-text-0").style("padding-top", (innerHeight - d3.select(".g-item-text-0 .g-item-text-inner").node().getBoundingClientRect().height) + "px")
} else {
  d3.select(".g-cover-img").html("").append('img').attr('src', prefix + "chow-cover.png")
}


positionTextBlocks();
drawVidScroll();

function positionTextBlocks() {

  var heights = [];

  d3.selectAll(".g-item-text").each(function(){
    var el = d3.select(this).select(".g-item-text-inner");

    heights.push(el.node().getBoundingClientRect().height);

    var el2 = d3.select(this).select(".g-item-text-inner-2")


    if (innerWidth < 460) {
      el.style("top", (innerHeight - (el2.node().getBoundingClientRect().height) - 50) + "px")
    } else {
      el.style("top", (innerHeight/2 - el2.node().getBoundingClientRect().height/3) + "px")
    }
  }) 

  heights.sort((a,b) => b - a)
  d3.selectAll(".g-item-text .g-item-text-inner").style("height", heights[0] + "px")
}

function drawVidScroll() {

  var scrollPercent;
  var calc = [];

  var firstoffset = d3.select(".g-item-text-cont .g-item-text").node().getBoundingClientRect().top;
  d3.selectAll(".g-item-text-cont .g-item-text").each(function(){

    var el = d3.select(this);
    var inner = el.select(".g-item-text-inner");
    var outerbb = el.node().getBoundingClientRect();
    var bb = inner.node().getBoundingClientRect();

    var row = {
      id: el.attr("data-id"),
      time: el.attr("data-time"),
      actualtime: el.attr("data-actualtime"),
      top: outerbb.top - firstoffset,
      //innerWidth < 460 ? outerbb.top-firstoffset+outerbb.height-innerHeight*2 : outerbb.top-firstoffset+outerbb.height,
      threshold: bb.height + (bb.top - firstoffset) - innerHeight,
      height: bb.height
    }

    calc.push(row)
  })

  var cont = d3.select("#g-model-cont").html("");

  // cont.append("div.g-scroll-vid")
  //   // .html("<video id='v0' poster='https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/cctv-compile.jpg' src='https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/cctv-compile.mp4' autobuffer preload>")
  //   .html("<video id='v0' src='https://interactive.thestandnews.com/ECQXRuFvL7rTmMk2UR9nzAPagtIuvoNdXhRhDUxmpJnoPA6KSHYQtlEEZvs2/CLKanimation1_1.mp4' autobuffer preload>")

  var storyclock = d3.select(".g-clock");
  var clockshown = false;
  var prev = {id:-1};
  var imgstuck = true;

  function modelRun() {

    var itemHeight = d3.select(".g-item-text-cont").node().getBoundingClientRect().height;
    var currY = window.scrollY;
    scrollPercent = (currY / (itemHeight - innerHeight));

    if (scrollPercent == 0) {
      d3.select("#main-menu").style("display", "block")
    } else if (scrollPercent > 0) {
      d3.select("#main-menu").style("display", "none")
    }

    // // get current text block, get next text block
    var inview = calc.filter(d => (d.top) < currY);
    var cur = inview[inview.length - 1]
    var next = calc[calc.indexOf(cur)+1]

    var curEl, curVid;
    if (cur) {

      nextEl = d3.select(".g-item-text-" + (+cur.id+1));

      if (nextEl) {
        nextVid = nextEl.select("video");

        if (nextVid.node() && !nextVid.attr("src")) {
          nextVid.attr("src", nextVid.attr("data-src"))
        }
      }

    }

    // console.log(currY, calc)
    var firststickybb = d3.select(".g-item-text-0 .g-item-text-inner-sticky").node().getBoundingClientRect()
    if ((currY > (firststickybb.top + firststickybb.height)) && imgstuck) {
      d3.select(".g-cover-img").classed("g-hide", true)
      d3.select(".g-cover-img").style("top", (firststickybb.top + firststickybb.height) + "px")
      imgstuck = false
    } else if (!imgstuck && (currY < (firststickybb.top + firststickybb.height))) {
      d3.select(".g-cover-img").classed("g-hide", false)
      d3.select(".g-cover-img").style("top", "0px")
      imgstuck = true;
    }
    // else {
    //   d3.select(".g-cover-img").classed("g-hide", false)
    // }


    if (cur && cur.id == "15" && clockshown) {
      storyclock.classed("g-active", false);
      clockshown = false;
    } else if (cur && cur.id != "0" && cur.id != "15" && !clockshown) {
      storyclock.classed("g-active", true);
      clockshown = true;
      storyclock.select(".g-clock-countdown").html("周梓樂被發現墮樓前<b>2</b><i>小時</i>")
      storyclock.select(".g-clock-time").html("23<b>:</b>06")
    } else if (!cur || (cur.id == "0" && clockshown)) {
      storyclock.classed("g-active", false)
      clockshown = false;

      storyclock.select(".g-clock-countdown").html("周梓樂被發現墮樓前<b>2</b><i>小時</i>")
      storyclock.select(".g-clock-time").html("23<b>:</b>06")
    }

    if (cur && next) {

      var curtime = cur && cur.time != "" ? cur.time : "";
      var nexttime = next && next.time != "" ? next.time : "";

      var curactualtime = cur && cur.actualtime != "" ? cur.actualtime : "";
      var nextactualtime = next && next.actualtime != "" ? next.actualtime : "";

      var calcpct = (currY-cur.top)/(next.top - cur.top)

      var curid = cur.id;

      function pad(n, width, z) {
        z = z || '0';
        n = n + '';
        return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
      }

      function addMinutes(date, minutes) {
          return new Date(date.getTime() + minutes*60000);
      }

      
      if (cur.id != prev.id) {

        var countdown = storyclock.select(".g-clock-countdown")
        var actualtime = storyclock.select(".g-clock-time");
        var clockdate = storyclock.select(".g-clock-date");

        // if (prev.time == "被發現墮樓前 2 小時" && cur.time == "被發現墮樓前 40 分鐘") {
        if (cur.time != "") {

          var str = cur.time;
          str = str.split(" ").join("")
          str = str.replace("墮樓一刻", "<b>周梓樂墮樓一刻</b>")
          
          if (str.indexOf("分鐘") > -1) {
            str = str.replace("被發現墮樓前", "周梓樂被發現墮樓前<b>").replace("被發現墮樓後", "周梓樂被發現墮樓後<b>").replace("小時", "</b><i>小時</i><b>").replace("分鐘", "</b><i>分鐘</i>")
          } else {
            str = str.replace("被發現墮樓前", "周梓樂被發現墮樓前<b>").replace("被發現墮樓後", "周梓樂被發現墮樓後<b>").replace("小時", "</b><i>小時</i>")
          }

          countdown.html(str)


            if (str.indexOf("墮樓一刻") > -1) {
              storyclock.select(".g-clock-countdown").classed("g-flashing", true)
            } else {
              storyclock.select(".g-clock-countdown").classed("g-flashing", false)
            }
        }



        if (cur.actualtime != "") {
          actualtime.html(cur.actualtime.split(":").join("<b>:</b>"))


          if (cur.actualtime.split(":")[0] != "23") {
            clockdate.html("2019.11.4")
          } else {
            clockdate.html("2019.11.3")
          }

        }
        // }

        // console.log(prev, cur)




        prev = cur;

      }

      // if (curtime && nexttime) {
      //   var clockstr = "";
      //   var timestr = "";

      //   if (curtime.indexOf("被發現墮樓前") > -1 && nexttime.indexOf("被發現墮樓前") > -1) {
      //     if (curtime.indexOf(" 2 小時") > -1) {
      //       var min = (80 - Math.round((80*calcpct)))+40

      //       if (min == 120) {
      //         clockstr = "被發現墮樓前<b>2</b><i>小時</i>"
      //         timestr = "23:06"
      //       } else if (min > 60) {
      //         clockstr = "被發現墮樓前<b>1</b><i>小時</i><b>" + (min-60) + "</b><i>分鐘</i>"
      //       } else if (min == 60) {
      //         clockstr = "被發現墮樓前<b>1</b><i>小時</i>"
      //       } else {
      //         clockstr = "被發現墮樓前<b>" + (min) + "</b><i>分鐘</i>"
      //       }

      //       var newt = new Date(2020,0,1,23,6)
      //       newt = addMinutes(newt, 120 - min)
      //       timestr = pad(newt.getHours(),2) + "<b>:</b>" + pad(newt.getMinutes(),2);


      //       if (newt.getDate() == 2) {
      //         storyclock.select(".g-clock-date").html("2019.11.4")
      //       } else {
      //         storyclock.select(".g-clock-date").html("2019.11.3")
      //       }


      //     } else if (curtime.indexOf("分鐘") && nexttime.indexOf("分鐘")) {
      //       var firstmin = +curtime.split("被發現墮樓前")[1].split("分鐘")[0].trim();
      //       var secondmin = +nexttime.split("被發現墮樓前")[1].split("分鐘")[0].trim();
      //       var diff = (Math.round((((secondmin-firstmin)*calcpct)))+firstmin)
      //       clockstr = "被發現墮樓前<b>" + diff + "</b><i>分鐘</i>"

      //       var newt = new Date(2020,0,1,23,6)
      //       newt = addMinutes(newt, 120 - diff)
      //       timestr = pad(newt.getHours(),2) + "<b>:</b>" + pad(newt.getMinutes(),2);

      //     }
      //   } else if (nexttime == "墮樓一刻" || nexttime == "被發現墮樓後") {
      //     clockstr = nexttime
      //     timestr = "01:02 - 01:06"
      //   } else {
      //     var firstmin = curtime == "墮樓一刻" ? 1 : +curtime.split("墮樓後")[1].split("分鐘")[0].trim();
      //     var secondmin = +nexttime.split("墮樓後")[1].split("分鐘")[0].trim();
      //     var calcmin = Math.round((secondmin-firstmin)*calcpct)+firstmin;
      //     clockstr = calcmin == 0 ? "被發現墮樓後" : "被發現墮樓後<b>" + calcmin + "</b><i>分鐘</i>";
      //     var newt = new Date(2020,0,1,1,6)
      //     newt = addMinutes(newt, calcmin)
      //     timestr = pad(newt.getHours(),2) + "<b>:</b>" + pad(newt.getMinutes(),2);
      //   }


      //   if (clockstr == "墮樓一刻") {
      //     storyclock.select(".g-clock-countdown").classed("g-flashing", true)
      //   } else {
      //     storyclock.select(".g-clock-countdown").classed("g-flashing", false)
      //   }
        
      //   storyclock.select(".g-clock-countdown").html(clockstr)
      //   storyclock.select(".g-clock-time").html(timestr)
      // }

    }

  }

  window.addEventListener("scroll", modelRun);

}


let winWidth          = innerWidth,
    winHeight         = innerHeight,
    ratio             = winHeight / winWidth,
    aspect            = ratio > 1 ? "mobile" : "desktop",
    vidsLoaded        = 0,
    containers        = [],
    forceFallbackMode = false,
    debugMode         = false;

//TODO: add debug container
// "desktop": [960,1280,1600]z
// "mobile": [640,800]

function create (obj, scrollCallback)
{


  const scrollContainer = $ (".g-item-text-cont").get (0),
        video           = obj.vidEl,
        rows            = obj.rows,
        keyFrameLength  = (obj["keyFrameLength"] === undefined) ? 3     : Number.parseInt (obj["keyFrameLength"], 10),
        frameRate       = (obj["framerate"]      === undefined) ? 30    : Number.parseInt (obj["framerate"], 10),
        frameLength     = (obj["framelength"]    === undefined) ? 900   : Number.parseInt (obj["framelength"], 10),
        startScroll     = (obj["startscroll"]    === undefined) ? 0     : Number.parseFloat (obj["startscroll"]),
        endScroll       = (obj["endscroll"]      === undefined) ? 1     : Number.parseFloat (obj["endscroll"]),
        heightMult      = (obj["height"]         === undefined) ? 1.2   : Number.parseFloat (obj["height"]),
        desktopSizes    = (obj["desktop"]        === undefined) ? "960" : obj["desktop"],
        mobileSizes     = (obj["mobile"]         === undefined) ? "800" : obj["mobile"],
        controller      = new ScrollMagic.Controller ({ container: window }), // using #shell for mobile?
        scene           = new ScrollMagic.Scene (
                            {
                              triggerElement: scrollContainer, 
                              triggerHook: "onCenter",
                              offset: -winHeight / 2
                            });


  let scrollPct        = 0,
      videoLastFrame   = 0,
      overlayRanges    = [],
      slideRanges      = [],
      edgeLabelOpacity = 0.1,
      stepDivisor      = 10,
      videoCanUpdate   = false,
      custTimer        = null,
      playThroughTimer = null,
      readyState       = false,
      fallbackImages   = [],
      pctVal           = 0,
      slidesHeight     = 0;

  obj.slides.forEach (
    function (value)
    {
      let height = value.height === undefined ? winHeight : Number.parseFloat (value.height) * winHeight;
      slidesHeight += height;
    });

    //pctVal = 1 / obj.slides.length; // / 4;

  obj.slides.forEach (
    function (value)
    {
      let height    = value.height === undefined ? winHeight : Number.parseFloat (value.height) * winHeight,
          heightPct = height / slidesHeight;

      if (value.type ===  "overlay") overlayRanges.push ([pctVal, pctVal + heightPct]);
      slideRanges.push ([pctVal, pctVal + heightPct]);
      pctVal += heightPct;
    });

  if (debugMode) console.log ("videoscroll", obj["id"], "overlayRanges", overlayRanges);
  if (debugMode) console.log ("videoscroll", obj["id"], "slideRanges", slideRanges);

  // $ (window).on ("resize", _.throttle (function ()
  //   {
  //     scene.offset (-$ (window).height () / 2);
  //     scene.duration (scrollContainer.clientHeight + $ (window).height ());
  //   }, 150));

  const setupPage = () =>
  {
    // console.log()
    let height  = frameRate * frameLength * heightMult,
        slides  = document.querySelectorAll ("." + scrollContainer.className.split(" ")[1] + " > div.g-video-annotations > div"),
        count   = 0,
        lastVal = 0;

    // scrollContainer.style.height = height + "px";
    //console.log (scrollContainer.className);

    function displayTime(currentFrame) {
      var fps = frameRate;
      var h = Math.floor(currentFrame/(60*60*fps));
      var m = (Math.floor(currentFrame/(60*fps))) % 60;
      var s = (Math.floor(currentFrame/fps)) % 60;
      var f = 1 - ((currentFrame % fps) * fps);
      return showTwoDigits(h) + ":" + showTwoDigits(m) + ":" + showTwoDigits(s) + "." + showTwoDigits(f);
    }

    function showTwoDigits(number) {
      return ("00" + number).slice(-2);
    }

    if (debugMode)
    {
      for (let i = 0; i < 1; i += 0.01)
      {
        let slideContainer = document.querySelector ("." + scrollContainer.className + "> div.g-video-annotations"),
            debugSlide     = document.createElement ("div"),
            videoPct       = i <= startScroll ? 0 : i >= endScroll ? 1 : (i - startScroll) /  (endScroll - startScroll);

        debugSlide.innerHTML       = i.toFixed (2) + " | " + videoPct.toFixed (2) + " | " + displayTime (Math.floor (videoPct * frameLength));
        debugSlide.className       = "g-videoscroll-debug";
        debugSlide.style.height    = "1px";
        debugSlide.style.position  = "absolute";
        debugSlide.style.top       = (height * i) + "px";

        slideContainer.appendChild (debugSlide);
      }
    }

    obj.slides.forEach (
      function (value, index)
      {
        let parsePct = Number.parseFloat (obj.slides[index].percent),
            valPct   = isNaN (parsePct) ? 0 : parsePct,
            yPos     = obj.slides[index].percent !== undefined ? valPct * height : 0,
            videoPct = valPct <= startScroll ? 0 : valPct >= endScroll ? 0.995 : (valPct - startScroll) /  (endScroll - startScroll);

        // if (value.template === undefined)
        // {
          // slides[index].style.height = "1px";
          // slides[index].style.position  = "absolute";
          // slides[index].style.top = yPos + "px";
        // }

        if (debugMode) console.log ("ffmpeg -y -i /Users/202855/projects/preview/2019-05-22-video-upload/public/_assets/rifle-spinning-1600.mp4 -ss " + displayTime (videoPct * frameLength) + " -qscale:v 10 -qscale:v 10 -vframes 1 /Users/202855/projects/preview/2019-06-26-assault-weapon-laws/public/_assets/fallback/fallback-desktop-" + ("00" + (index + 1)).slice (-2) + ".jpg -hide_banner");
      });
  };

  const startScrollAnimation = () =>
  {
    scene.addTo (controller)
         .duration (scrollContainer.clientHeight + winHeight)
         .on ("progress", (e) =>
          {
            if (e.state === "BEFORE" || e.state === "AFTER") videoCanUpdate = false;
            if (e.state === "DURING") showAllElements ();
            else hideAllElements (e.state);

            if (scrollPct !== e.progress)
            {
              let scrollAdj = e.progress; // - 0.04761904762;
              scrollCallback (obj["id"], scrollPct);
              scrollPct = scrollAdj;

              if (!videoCanUpdate)
              {
                adjustScrollPct ();
              }
            }

            checkOverlays (e.progress);
            if (debugMode) console.log ("videoscroll", obj["id"], "scrollPct", scrollPct);
         })
        .on ("enter", (e) => { showAllElements (); })
        .on ("leave", (e) => { hideAllElements (e.state); })
  };

  const showAllElements = () =>
  {
    //videoCanUpdate = true;
    // video.style.opacity = 1;
    // video.style.visibility = "visible"; 
  };

  const hideAllElements = (state) =>
  {
    // video.style.opacity = 0;
    // video.style.visibility = "hidden";
    // hideFallback ();
  };

  const checkOverlays = (pct) =>
  {
    let overlayFound = false;

    overlayRanges.forEach (
      function (range)
      {
        if (pct >= range[0] && pct <= range[1])
        {
          $ (".video-cover").addClass ("g-show");
          overlayFound = true;
        }
      });

    if (!overlayFound) $ (".video-cover").removeClass ("g-show");
  };

  const jumpToTime = (pct) =>
  {

    let videoNextFrame   = frameLength * pct,
        videoCurrFrame   = videoLastFrame + ((videoNextFrame - videoLastFrame) / stepDivisor),
        //videoSnapFrame = getClosestKeyframe (videoCurrFrame, keyFrameLength),
        frameToUse       = videoCurrFrame < 0 ? 0 : videoCurrFrame > frameLength ? frameLength : videoCurrFrame,
        isBuffered       = checkBuffered (frameToUse);

    if (isBuffered)
    {
      hideFallback ();
      frameToUse          = checkForPauses (frameToUse, pct);
      let timeFromKeyrame = getTimeFromKeyframe (frameToUse);
      video.currentTime   = timeFromKeyrame < 0 ? 0 : timeFromKeyrame > frameLength ? frameLength : timeFromKeyrame;

      // console.log(video.currentTime)

      if (rows !== null) moveLabels ();

      if (Math.abs (videoNextFrame - frameToUse) < keyFrameLength + 1) videoCanUpdate = false;
      else videoCanUpdate = true;
    }
    else
    {
      showFallback ();
    }

    videoLastFrame = frameToUse;
  };

  const getClosestKeyframe = (currentTime, duration) =>
  {
    let frameFract = (frameLength / frameRate) * currentTime,
        closestFrame = roundKeyframe (frameFract);

    return closestFrame / duration;
  };

  const roundKeyframe = (frame) =>
  {
    return (Math.floor (frame / keyFrameLength) * keyFrameLength ) + 1;
  };

  const getTimeFromKeyframe = (keyframe) =>
  {
    return keyframe / frameRate;
  };

  const adjustScrollPct = () =>
  {
    clearTimeout (custTimer);

    if (scrollPct > startScroll && scrollPct < endScroll)
    {
      let adjustedPct = (scrollPct - startScroll) / (endScroll - startScroll);
      adjustedPct     = adjustedPct > 1 ? 1 : adjustedPct < 0 ? 0 : adjustedPct;
      custTimer       = setTimeout (function () { jumpToTime (adjustedPct) }, 10);
    }
    else if (scrollPct <= startScroll) custTimer = setTimeout (function () { jumpToTime (0) }, 10);
    else if (scrollPct >= endScroll) custTimer = setTimeout (function () { jumpToTime (1) }, 10);
  };

  const checkBuffered = (frameToUse) =>
  {
    if (forceFallbackMode) return false;

    if (!readyState) return false;

    let fallbackLen   = obj.slides.length,
        fallbackRange = { start: 0, end: 0 },
        currPct       = frameToUse / frameLength,
        bufferedLen   = video.buffered.length,
        isBuffered    = false;

    currPct = currPct < 0 ? 0 : currPct > 1 ? 1 : currPct;

    while (fallbackLen--)
    {
      if (fallbackImages[fallbackLen] === undefined) break;
      if (currPct > fallbackImages[fallbackLen].start)
      {
        let start = fallbackImages[fallbackLen].start,
            end   = fallbackLen === obj.slides.length - 1 ? 1 : parseFloat (fallbackImages[fallbackLen + 1].start);

        fallbackRange.start = start;
        fallbackRange.end   = end;
        break;
      }
    } 

    while (bufferedLen--)
    {
      let buffStart = video.buffered.start (bufferedLen),
          buffEnd   = video.buffered.end (bufferedLen);
      if (currPct >= buffStart && currPct <= buffEnd)
      {
        if (fallbackRange.start >= buffStart && fallbackRange.end <= buffEnd)
        {
          isBuffered = true;
          break;
        }
      }
    }

    return isBuffered;
  };

  const checkForPauses = (frameToUse, pct) =>
  {
    if (obj.pauses !== undefined)
    {
      let pausesLen = obj.pauses.length;

      while (pausesLen--)
      {
        if (pct > obj.pauses[pausesLen].start &&
            pct < obj.pauses[pausesLen].end)
        {
          let adjNextFrame = frameLength * obj.pauses[pausesLen].start,
              adjCurFrame  = videoLastFrame + ((adjNextFrame - videoLastFrame) / stepDivisor);
              
          return adjCurFrame;
        }
      }
    }

    return frameToUse;
  };

  const createLabels = () =>
  {
    // if (rows !== null)
    // {
    //   let rowsLen = rows.length;

    //   while (rowsLen--)
    //   {
    //     if (rows[rowsLen]["videoID"] === obj["id"])
    //     {
    //       let label       = document.createElement ("div");
    //       label.id        = obj["id"] + "_label_" + rows[rowsLen]["labelID"];
    //       label.className = rows[rowsLen]["className"];
    //       label.innerHTML = rows[rowsLen]["labelText"];
    //       $ ("#" + obj["id"]).append (label);
    //       $ (label).data ("start", rows[rowsLen]["start"]);
    //       $ (label).data ("end", rows[rowsLen]["end"]);
    //     }
    //   }
    // }
  };

  const moveLabels = () =>
  {
    let curWidth    = video.clientWidth,
        curHeight   = video.clientHeight,
        srcWidth    = video.videoWidth,
        srcHeight   = video.videoHeight,
        curRatio    = curWidth / curHeight,
        srcRatio    = srcWidth / srcHeight;

    for (let label in _videoScrollLabels)
    {
      if (_videoScrollLabels.hasOwnProperty (label) &&
          videoLastFrame >> 0 >= 0 &&
          videoLastFrame >> 0 <= frameLength &&
          videoLastFrame >> 0 < _videoScrollLabels[label].length)
      {
        let divElem  = $ ("#" + obj["id"] + "_label_" + label),
            labelObj = divElem.get (0),
            start    = divElem.data ("start"),
            end      = divElem.data ("end"),
            videoPct = videoLastFrame / frameLength,
            pctX     = _videoScrollLabels[label][(videoLastFrame >> 0) * 2][0],
            pctY     = _videoScrollLabels[label][(videoLastFrame >> 0) * 2][1];

            pctX = curRatio < srcRatio ? ((pctX - 0.5) * srcRatio) + 0.5 : pctX;
            pctY = curRatio > srcRatio ? ((pctY - 0.5) * curRatio) + 0.5 : pctY;

        if (pctX !== undefined && pctY !== undefined &&
            pctX > 0 && pctX < 1 &&
            pctY > 0 && pctY < 1 &&
            labelObj !== undefined)
        {
          labelObj.style.transform = "translate3d(" + (pctX * curWidth) + "px," + (pctY * curHeight) + "px, 0)";

          if (videoPct >= start && videoPct <= end) labelObj.style.opacity = 1.0; //Math.abs (Math.sin (pctY * Math.PI)) + edgeLabelOpacity;
          else labelObj.style.opacity = 0;
        }
        else if (labelObj !== undefined) labelObj.style.opacity = 0;
      }
    }
  };

  const loadFallbackImages = (index, imagesArr) =>
  {
    if (index > imagesArr.length - 1)
    {
      if (debugMode) console.log ("videoscroll", obj["id"], "fallbackImages", fallbackImages);
      return;
    }

    let container = $ (scrollContainer).find (".video_fallback"),
        img       = document.createElement ("img"),
        fallback  = imagesArr[index],
        start     = imagesArr[index].percent; //parseFloat (fallback.start);

    fallbackImages.push ({ start: start, image: img });
    container.append (img);

    img.onload = function ()
                 { 
                   if (!index) img.classList.add ("g-show");
                   ;setTimeout (function () { loadFallbackImages (++index, imagesArr) }, 100);
                 } //function () { loadFallbackImages (++index, imagesArr) };
    img.src    = aspect === "desktop" ? imagesArr[index].fallbackdesktop : imagesArr[index].fallbackmobile;
  };

  const showFallback = () =>
  {
    _.each (fallbackImages, function (f)
      {
        if (scrollPct >= f.start && scrollPct > 0)
        {
          if (debugMode) console.log ("videoscroll", obj["id"], "fallback", f);
          f.image.classList.add ("g-show");
        } 
        else f.image.classList.remove ("g-show");
      })
    // video.style.opacity = 0;
    // video.style.visibility = "hidden";
  };

  const hideFallback = () =>
  {
    _.each (fallbackImages, function (f)
      {
        f.image.classList.remove ("g-show")
      })
    video.style.opacity = 1;
    video.style.visibility = "visible";
  };

  video.addEventListener ("timeupdate", function ()
  {
    if (videoCanUpdate) adjustScrollPct ();
    else clearTimeout (custTimer);
  });

  setupPage ();
  createLabels ();
  loadFallbackImages (0, obj.slides);

  playThroughTimer = setInterval (function ()
  {
    if (video.readyState > 3)
    {
      video.pause ();
      clearInterval (playThroughTimer);
      video.currentTime = 0;
      readyState = true;
    }
  }, 10);

  startScrollAnimation ();

}

function preventEvent (element, eventName, test)
{
  function handler (e)
  {
    if (!test || test (element, eventName))
    {
      e.stopImmediatePropagation ();
    }
  }

  element.addEventListener (eventName, handler);
  return handler;
}

function init (doc, rows, scrollCallback)
{

  doc = {body: [{
            "type": "video",
            "value": {
                "id": "scrolling_video_1",
                "type": "videoscroll",
                "framerate": "30",
                "framelength": "1200",
                "startscroll": "0",
                "endscroll": "1",
                "height": "1",
                "asset-max-width": "bleed",
                "asset": "video-transition-1",
                "slides": [
                    {
                        "text": "",
                        "percent": "0.5",
                        "fallbackdesktop": prefix + "desktop.jpg",
                        "fallbackmobile": prefix + "mobile.jpg"
                    }
                ],
                "url": ""
            },
            "css": "",
            "videoID": "video-transition-1",
            "options": "{}"
        }]};

  let filtered = _.filter (doc.body, function (item) { return item.value.type === "videoscroll" });
  let videos   = _.map (filtered, function (vid)
    {
      let v = document.createElement ("video")
      v.preload     = "auto";
      v.muted       = true;
      v.playsinline = true;
      v.setAttribute ("playsinline", true);
      v.setAttribute ("autoplay", true);
        
      preventEvent (v, "seeking", function (el) { return });
      preventEvent (v, "seeked", function (el) { return });

      return _.extend (vid.value,
        {
          vidEl:       v,
          rows:        rows,
          scrollSetup: false,
          setSrc: function (callback)
            { 
              let url           = null,
                  loadNextVideo = null,
                  size          = null,
                  desktopSizes  = [],
                  mobileSizes   = [],
                  videoSizes    = {},
                  self          = this;

              document.getElementById ("g-model-cont").appendChild (self.vidEl);

              create (self, scrollCallback);

              var size_use = innerWidth < 460 ? "mobile-600.mp4" : innerWidth < 720 ? "desktop-900.mp4" : innerWidth < 1600 ? "desktop-1600.mp4" : "desktop-1920.mp4";

              url = prefix + size_use + "?esdrtfygubhinjmk";

              // url = "https://interactive.thestandnews.com/2020/11/chow-tsz-lok-3d-model/clkanimation3.mp4"
              // url = "vid/clkanimation4_1_1.mp4"

              self.vidEl.src = url;
              self.vidEl.poster = innerWidth < 460 ? prefix + "mobile.jpg" : prefix + "desktop.jpg";
              self.vidEl.play ();

              d3.select("#g-model-cont").classed("g-loaded", true)
            }
        })
    })

  function LoadVideosAsync ()
  {
    if (vidsLoaded < videos.length) videos[vidsLoaded].setSrc (LoadVideosAsync);
    vidsLoaded++;
  }

  LoadVideosAsync ();
}

function debug (mode)
{
  if (typeof mode === undefined) return debugMode;
  debugMode = mode;
}

function forceFallback (mode)
{
  if (typeof mode === undefined) return forceFallbackMode;
  forceFallbackMode = mode;
}


init(null, null, function(){});








var containerWidthChanged = false;
var ow = innerWidth;
var oh = innerHeight;

window.addEventListener("resize", function(){
  // if (innerWidth != ow || innerHeight != oh) {
  //     containerWidthChanged = true;
  //     ow = innerWidth;
  //     oh = innerWidth;
      positionTextBlocks();
      init(null, null, function(){});
    // }
});
</script>